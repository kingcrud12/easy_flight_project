<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Comparateur de vols ‚Ä¢ SerpApi</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script data-noptimize="1" data-cfasync="false" data-wpfc-render="false">
        (function () {
        var script = document.createElement("script");
        script.async = 1;
        script.src = 'https://emrld.ltd/NDc2OTM4.js?t=476938';
        document.head.appendChild(script);
        })();
    </script>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --primary: #0b5cff;
      --primary-dark: #083fe5;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #e2e8f0;
      --success: #16a34a;
      --danger: #dc2626;
      --shadow: 0 30px 60px rgba(15,23,42,0.1);
    }

    * { box-sizing: border-box; }
    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 32px 20px 64px;
      background: radial-gradient(circle at top, #dce8ff 0%, #f4f6fb 45%, #f7f8fc 100%);
      color: var(--text);
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .hero {
      display: flex;
      flex-direction: column;
      gap: 16px;
      text-align: center;
      margin-bottom: 32px;
    }
    .hero h1 {
      font-size: clamp(2rem, 4vw, 3rem);
      margin: 0;
    }
    .hero p {
      color: var(--muted);
      margin: 0 auto;
      max-width: 720px;
      line-height: 1.5;
    }
    .badge-row {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .badge {
      background: rgba(11,92,255,0.08);
      color: var(--primary);
      border: 1px solid rgba(11,92,255,0.2);
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 13px;
      font-weight: 500;
    }
    .search-card {
      background: var(--card);
      border-radius: 24px;
      padding: 28px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    .search-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .search-header h2 {
      margin: 0;
      font-size: 1.5rem;
    }
    .small {
      font-size: 0.9rem;
      color: var(--muted);
      margin: 0;
    }
    label {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text);
    }
    .input-with-picker {
      position: relative;
      display: flex;
      align-items: center;
    }
    input, select {
      margin-top: 6px;
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 0.95rem;
      background: #f9fafb;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .picker-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(11,92,255,0.12);
      color: var(--primary);
      border: none;
      border-radius: 8px;
      padding: 5px 12px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.15s;
    }
    .picker-btn:hover {
      background: rgba(11,92,255,0.22);
      transform: translateY(calc(-50% - 1px));
    }
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 3px rgba(11,92,255,0.12);
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    button {
      border: none;
      border-radius: 12px;
      padding: 14px 20px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .primary-btn {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 10px 25px rgba(11,92,255,0.25);
    }
    .primary-btn:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    .ghost-btn {
      background: rgba(15,23,42,0.05);
      color: var(--text);
    }
    #status {
      margin-top: 20px;
      font-weight: 600;
    }
    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 0.9rem;
      background: rgba(15,23,42,0.05);
    }
    .status-chip.success { color: var(--success); background: rgba(22,163,74,0.08); }
    .status-chip.error { color: var(--danger); background: rgba(220,38,38,0.08); }
    .status-chip.loading { color: var(--primary); background: rgba(11,92,255,0.08); }

    .results-wrapper {
      margin-top: 32px;
    }
    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(330px, 1fr));
      gap: 22px;
    }
    .flight-card {
      background: var(--card);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid var(--border);
      box-shadow: 0 20px 50px rgba(15,23,42,0.08);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .price-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }
    .price {
      font-size: 1.8rem;
      font-weight: 700;
    }
    .meta {
      display: flex;
      gap: 10px;
      font-size: 0.85rem;
      color: var(--muted);
      flex-wrap: wrap;
    }
    .tag {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.05);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .card-tags {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .source-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(11,92,255,0.12);
      color: var(--primary);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: capitalize;
    }
    .trip-dates {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(11,92,255,0.06);
      border: 1px solid rgba(11,92,255,0.12);
      font-size: 0.9rem;
    }
    .trip-dates-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 120px;
    }
    .trip-dates-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
      font-weight: 600;
    }
    .trip-dates-value {
      font-weight: 600;
      color: var(--text);
    }
    .trip-dates-divider {
      width: 1px;
      height: 36px;
      background: rgba(15,23,42,0.15);
    }
    .segments {
      font-size: 0.9rem;
      line-height: 1.5;
      color: var(--text);
    }
    .card-actions {
      margin-top: auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 14px;
    }
    .book-link {
      color: #fff;
      background: var(--primary);
      padding: 10px 16px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 600;
      flex: 1;
      text-align: center;
    }
    .book-link:hover {
      background: var(--primary-dark);
    }
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      background: var(--card);
      border-radius: 24px;
      border: 1px dashed var(--border);
      color: var(--muted);
      margin-top: 24px;
    }
    .empty-state strong {
      color: var(--text);
      display: block;
      font-size: 1.1rem;
      margin-bottom: 8px;
    }
    code {
      background: rgba(15,23,42,0.08);
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 0.85rem;
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal-backdrop.open {
      display: flex;
    }
    .iata-modal {
      background: var(--card);
      border-radius: 22px;
      width: min(640px, 100%);
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow);
    }
    .iata-modal header {
      padding: 20px 24px 8px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }
    .iata-modal h3 {
      margin: 0;
    }
    .iata-modal .close-btn {
      border: none;
      background: rgba(15,23,42,0.08);
      border-radius: 999px;
      width: 36px;
      height: 36px;
      cursor: pointer;
      font-size: 1.1rem;
    }
    .target-chips {
      display: flex;
      gap: 10px;
      padding: 0 24px 16px;
      border-bottom: 1px solid var(--border);
    }
    .target-chip {
      flex: 1;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 16px;
      font-weight: 600;
      background: #fff;
      cursor: pointer;
      transition: border 0.2s, background 0.2s, color 0.2s;
    }
    .target-chip.active {
      border-color: var(--primary);
      background: rgba(11,92,255,0.1);
      color: var(--primary);
    }
    .iata-modal .search-area {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
    }
    .iata-modal .search-area input {
      margin-top: 0;
    }
    .iata-list {
      padding: 16px 24px 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .iata-item {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: border 0.2s, transform 0.1s, background 0.2s;
      text-align: left;
      gap: 12px;
    }
    .iata-item:hover {
      border-color: var(--primary);
      background: rgba(11,92,255,0.05);
      transform: translateY(-1px);
    }
    .iata-item strong {
      font-size: 1.1rem;
      display: block;
    }
    .iata-item span {
      display: block;
    }
    .iata-empty {
      padding: 40px;
      text-align: center;
      color: var(--muted);
    }
    .hidden {
      display: none !important;
    }
    @media (max-width: 640px) {
      body { 
        padding: 20px 12px 40px; 
        overflow-x: hidden;
      }
      .container {
        max-width: 100%;
        overflow-x: hidden;
      }
      .search-card { 
        padding: 20px 14px; 
        overflow-x: hidden;
        max-width: 100%;
      }
      .form-grid {
        grid-template-columns: 1fr;
        gap: 16px;
        width: 100%;
        max-width: 100%;
      }
      .form-grid > div {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        box-sizing: border-box;
      }
      input, select {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        box-sizing: border-box;
        padding: 12px 10px;
      }
      input[type="date"] {
        width: 100%;
        max-width: 100%;
        min-width: 0;
      }
      .input-with-picker {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        box-sizing: border-box;
      }
      .card-actions { flex-direction: column; }
      .book-link { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="hero">
      <h1>Comparez vos vols en un clin d‚Äô≈ìil</h1>
      <p>Entrez votre ville de d√©part, votre ville d'arriv√©e, vos dates et votre budget maximal pour obtenir une s√©lection claire des meilleures options disponibles.</p>
      <p>Nous sommes moins ch√®re et plus rapide que kayak.com.</p>
    </header>

    <section class="search-card">
      <div class="search-header">
      <div>
          <h2>Param√®tres de recherche</h2>
          <p class="small">Personnalisez la recherche avant de lancer l‚Äôappel API.</p>
        </div>
        <p class="small"><strong>Astuce :</strong> laissez <code>sort_by</code> vide pour l‚Äôordre par d√©faut SerpApi.</p>
      </div>

      <div class="form-grid">
        <div>
          <label for="departure">D√©part (IATA)</label>
          <div class="input-with-picker">
            <input id="departure" value="CDG" placeholder="Ex : CDG" />
            <button type="button" class="picker-btn" data-target="departure">Choisir</button>
          </div>
      </div>
      <div>
          <label for="arrival">Arriv√©e (IATA ou code multi)</label>
          <div class="input-with-picker">
            <input id="arrival" value="LON" placeholder="Ex : LON" />
            <button type="button" class="picker-btn" data-target="arrival">Choisir</button>
          </div>
      </div>
      <div>
          <label for="currency">Devise</label>
          <select id="currency">
            <option>USD</option>
            <option selected>EUR</option>
            <option>GBP</option>
          </select>
      </div>
      <div>
          <label for="outbound">Date d√©part</label>
          <input id="outbound" type="date" />
      </div>
      <div>
          <label for="return">Date retour</label>
          <input id="return" type="date" />
      </div>
      <div>
          <label for="maxprice">Prix max</label>
        <input id="maxprice" type="number" value="2000" />
      </div>
      <div>
          <label for="sortby">Sort_by (option)</label>
          <input id="sortby" placeholder="Ex : 2" />
      </div>
      <div>
          <label for="topn">Top N</label>
        <input id="topn" type="number" value="10" />
        </div>
      </div>

      <div class="actions">
        <button id="searchBtn" class="primary-btn">üîç Rechercher</button>
        <button id="downloadBtn" class="ghost-btn" disabled>‚¨áÔ∏è T√©l√©charger CSV</button>
    </div>

      <div id="status"></div>
    </section>

    <section class="results-wrapper" id="results"></section>
  </div>

  <div class="modal-backdrop" id="iataModal">
    <div class="iata-modal">
      <header>
        <div>
          <h3>Choisir un code IATA</h3>
          <p class="small">Cherchez par code, ville ou pays puis cliquez pour remplir le champ.</p>
        </div>
        <button class="close-btn" id="closeIataModal" aria-label="Fermer">‚úï</button>
      </header>
      <div class="target-chips">
        <button class="target-chip active" type="button" data-target="departure" id="chipDeparture" aria-pressed="true">D√©part</button>
        <button class="target-chip" type="button" data-target="arrival" id="chipArrival" aria-pressed="false">Arriv√©e</button>
      </div>
      <div class="search-area">
        <input id="iataSearch" type="text" placeholder="Rechercher (ex : Paris, FRA, Japon‚Ä¶)" />
      </div>
      <div class="iata-list" id="iataList"></div>
    </div>
  </div>

  <script>
    const apiBase = window.location.hostname.includes("onrender.com")
      ? "https://easy-flight-project.onrender.com"
      : "http://localhost:8000";

    const SOURCE_LABELS = {
      serpapi: "Google Flights",
      aviasales: "Aviasales",
    };

    const state = {
      csvUrl: null,
      iataCatalog: [],
      iataLoading: false,
      iataError: null,
      pickerTarget: null,
    };

    function formatSourceLabel(source) {
      if (!source) return null;
      return SOURCE_LABELS[source.toLowerCase()] || source;
    }

    function showStatus(text, tone = "idle") {
      const classes = {
        loading: "status-chip loading",
        success: "status-chip success",
        error: "status-chip error",
        idle: "status-chip",
      };
      const statusEl = document.getElementById("status");
      statusEl.innerHTML = `<span class="${classes[tone] || classes.idle}">${text}</span>`;
    }

    function formatDuration(minutes) {
      if (!minutes && minutes !== 0) return "Dur√©e inconnue";
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      if (!m) return `${h}h`;
      if (!h) return `${m} min`;
      return `${h}h ${m}min`;
    }

    function formatFrenchDate(dateStr) {
      if (!dateStr) return "‚Äî";
      const date = new Date(dateStr);
      if (Number.isNaN(date.getTime())) return "‚Äî";
      return new Intl.DateTimeFormat("fr-FR", {
        weekday: "short",
        day: "numeric",
        month: "long",
        year: "numeric",
      }).format(date);
    }

    function renderResults(data, contextDates = {}) {
      const resultsEl = document.getElementById("results");
      if (!data || !data.length) {
        resultsEl.innerHTML = `
          <div class="empty-state">
            <strong>Aucun trajet trouv√©</strong>
            Ajustez vos dates, augmentez le prix max ou essayez un autre hub.
          </div>
        `;
        return;
      }

      const cards = data
        .map((r, index) => {
          const outboundDate = r.outbound_date || contextDates.outbound;
          const returnDate = r.return_date || contextDates.return;
          const sourceLabel = formatSourceLabel(r.source);
          const tagMarkup = `
            <div class="card-tags">
              <span class="tag">${r.stops > 0 ? `${r.stops} escale${r.stops > 1 ? "s" : ""}` : "Vol direct"}</span>
              ${sourceLabel ? `<span class="source-pill">${sourceLabel}</span>` : ""}
            </div>
          `;
          const metaParts = [
            r.airlines || "Compagnie inconnue",
            r.total_duration_min ? formatDuration(r.total_duration_min) : "Dur√©e n.c.",
          ];
          if (sourceLabel) metaParts.push(`Source : ${sourceLabel}`);
          const metaHtml = metaParts
            .map((part, idx) => (idx === 0 ? `<span>${part}</span>` : `<span>‚Ä¢</span><span>${part}</span>`))
            .join("");

          return `
            <article class="flight-card">
              <div class="price-row">
                <div>
                  <div class="price">${r.price ?? "‚Äî"} ${r.currency || ""}</div>
                  <div class="meta">${metaHtml}</div>
                </div>
                ${tagMarkup}
              </div>

              <div class="trip-dates">
                <div class="trip-dates-block">
                  <span class="trip-dates-label">Aller</span>
                  <span class="trip-dates-value">${formatFrenchDate(outboundDate)}</span>
                </div>
                <div class="trip-dates-divider"></div>
                <div class="trip-dates-block">
                  <span class="trip-dates-label">Retour</span>
                  <span class="trip-dates-value">${formatFrenchDate(returnDate)}</span>
                </div>
              </div>

              <div class="segments">${r.segments_summary || "Segments non fournis"}</div>

              <div class="card-actions">
                <span class="small">Option #${index + 1}</span>
                ${
                  r.purchase_url
                    ? `<a class="book-link" href="${r.purchase_url}" target="_blank" rel="noopener">R√©server</a>`
                    : `<span class="small" style="color: var(--muted);">Lien indisponible</span>`
                }
              </div>
            </article>
          `;
        })
        .join("");

      resultsEl.innerHTML = `<div class="results-grid">${cards}</div>`;
    }

    function toCSV(rows) {
      if (!rows || !rows.length) return "";
      const keys = Object.keys(rows[0]);
      const lines = [keys.join(",")];
      rows.forEach((row) => {
        const values = keys
          .map((key) => {
            let value = row[key];
            if (value === null || value === undefined) return "";
            value = String(value).replace(/"/g, '""');
            if (value.includes(",") || value.includes("\n")) value = `"${value}"`;
            return value;
          })
          .join(",");
        lines.push(values);
      });
      return lines.join("\n");
    }

    function setDefaultDates() {
      const today = new Date();
      const outbound = today.toISOString().split("T")[0];
      const returnDate = new Date(today);
      returnDate.setDate(returnDate.getDate() + 7);
      document.getElementById("outbound").value = outbound;
      document.getElementById("return").value = returnDate.toISOString().split("T")[0];
    }

    async function searchFlights() {
      const departure = document.getElementById("departure").value.trim();
      const arrival = document.getElementById("arrival").value.trim();
      const outbound = document.getElementById("outbound").value;
      const ret = document.getElementById("return").value;
      const currency = document.getElementById("currency").value;
      const maxPrice = document.getElementById("maxprice").value;
      const sortBy = document.getElementById("sortby").value;
      const topN = document.getElementById("topn").value;

      showStatus("Recherche en cours...", "loading");

      try {
        const params = new URLSearchParams({
          departure_id: departure,
          arrival_id: arrival,
          outbound_date: outbound,
          return_date: ret,
          currency,
          max_price: maxPrice,
          sort_by: sortBy,
          top_n: topN,
        });

        const res = await fetch(`${apiBase}/search?${params.toString()}`);

        if (!res.ok) {
          const text = await res.text();
          showStatus(`Erreur API ${res.status} ‚Äî ${text}`, "error");
          document.getElementById("results").innerHTML = "";
          return;
        }

        const data = await res.json();
        renderResults(data.results, { outbound, return: ret });
        showStatus(`R√©ussite ‚Ä¢ ${data.count} r√©sultats`, "success");

        if (state.csvUrl) {
          URL.revokeObjectURL(state.csvUrl);
          state.csvUrl = null;
        }

        const csv = toCSV(data.results);
        if (csv) {
          state.csvUrl = URL.createObjectURL(new Blob([csv], { type: "text/csv;charset=utf-8;" }));
        const dlBtn = document.getElementById("downloadBtn");
          dlBtn.disabled = false;
        dlBtn.onclick = () => {
          const a = document.createElement("a");
            a.href = state.csvUrl;
          a.download = "flights_serpapi.csv";
          a.click();
        };
        }
      } catch (err) {
        console.error(err);
        showStatus(`Erreur : ${err.message}`, "error");
      }
    }

    async function loadIataCatalog() {
      if (state.iataCatalog.length || state.iataLoading) return;
      state.iataLoading = true;
      try {
        const res = await fetch("https://raw.githubusercontent.com/mwgg/Airports/master/airports.json");
        if (!res.ok) throw new Error(`Chargement IATA impossible (${res.status})`);
        const data = await res.json();
        state.iataCatalog = Object.values(data)
          .filter((entry) => entry.iata && entry.city && entry.country)
          .map((entry) => ({
            code: entry.iata,
            city: entry.city,
            country: entry.country,
          }))
          .sort((a, b) => a.city.localeCompare(b.city));
      } catch (err) {
        console.error("Erreur chargement IATA:", err);
        state.iataError = err;
      } finally {
        state.iataLoading = false;
      }
    }

    const modalBackdrop = document.getElementById("iataModal");
    const closeModalBtn = document.getElementById("closeIataModal");
    const iataListEl = document.getElementById("iataList");
    const iataSearchInput = document.getElementById("iataSearch");
    const targetChips = document.querySelectorAll(".target-chip");

    function setPickerTarget(targetId) {
      state.pickerTarget = targetId;
      targetChips.forEach((chip) => {
        const isActive = chip.dataset.target === targetId;
        chip.classList.toggle("active", isActive);
        chip.setAttribute("aria-pressed", String(isActive));
      });
    }

    function renderIataList(list) {
      if (state.iataError) {
        iataListEl.innerHTML = `<div class="iata-empty">Impossible de charger la liste IATA.<br/>${state.iataError.message}</div>`;
        return;
      }
      if (!list.length) {
        iataListEl.innerHTML = `<div class="iata-empty">Aucun code ne correspond √† votre recherche.</div>`;
        return;
      }
      iataListEl.innerHTML = list
        .map(
          (item) => `
        <button class="iata-item" data-code="${item.code}" data-city="${item.city}" data-country="${item.country}">
          <div>
            <strong>${item.code}</strong>
            <span>${item.city} (${item.country})</span>
          </div>
        </button>
      `,
        )
        .join("");
    }

    async function openIataPicker(targetId) {
      setPickerTarget(targetId);
      modalBackdrop.classList.add("open");
      iataSearchInput.value = "";
      if (!state.iataCatalog.length && !state.iataLoading) {
        await loadIataCatalog();
      }
      renderIataList(state.iataCatalog);
      setTimeout(() => iataSearchInput.focus(), 50);
    }

    function closeIataPicker() {
      modalBackdrop.classList.remove("open");
      state.pickerTarget = null;
      targetChips.forEach((chip) => {
        chip.classList.remove("active");
        chip.setAttribute("aria-pressed", "false");
      });
    }

    iataSearchInput.addEventListener("input", (e) => {
      const value = e.target.value.trim().toLowerCase();
      const filtered = state.iataCatalog.filter(
        (item) =>
          item.code.toLowerCase().includes(value) ||
          item.city.toLowerCase().includes(value) ||
          item.country.toLowerCase().includes(value),
      );
      renderIataList(filtered);
    });

    iataListEl.addEventListener("click", (e) => {
      const btn = e.target.closest(".iata-item");
      if (!btn || !state.pickerTarget) return;
      const input = document.getElementById(state.pickerTarget);
      if (input) {
        input.value = btn.dataset.code;
        input.focus();
      }
      closeIataPicker();
    });

    document.querySelectorAll(".picker-btn").forEach((btn) => {
      btn.addEventListener("click", () => openIataPicker(btn.dataset.target));
    });
    targetChips.forEach((chip) => chip.addEventListener("click", () => setPickerTarget(chip.dataset.target)));

    closeModalBtn.addEventListener("click", closeIataPicker);
    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) closeIataPicker();
    });

    document.getElementById("searchBtn").addEventListener("click", searchFlights);
    document.getElementById("downloadBtn").addEventListener("click", () => {
      if (document.getElementById("downloadBtn").disabled) {
        showStatus("Lancez d‚Äôabord une recherche pour g√©n√©rer le CSV.", "idle");
      }
    });

    window.addEventListener("beforeunload", () => {
      if (state.csvUrl) URL.revokeObjectURL(state.csvUrl);
    });

    setDefaultDates();
    renderResults([], {});
    showStatus("Configurez votre recherche puis lancez une requ√™te.");
  </script>
</body>
</html>
